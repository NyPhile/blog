!function(){"use strict";function t(t){t.preventDefault()}function i(){function t(){this.keys=$(".map .k"),this.type=0,this.config={types:[{img:"img/img1.png",c_l:60,c_t:170,c_w:200,c_h:300,title:"我和美国总统特朗普合张影"},{img:"img/img2.png",c_l:70,c_t:46,c_w:300,c_h:300,title:"我和俄罗斯总统普京普合张影"},{img:"img/img3.png",c_l:70,c_t:46,c_w:300,c_h:300,title:"我和加拿大总理特鲁多合张影"},{img:"img/img4.png",c_l:470,c_t:140,c_w:200,c_h:200,title:"我和法国总统马克龙合张影"},{img:"img/img5.png",c_l:440,c_t:60,c_w:200,c_h:200,title:"我和凯特王妃普合张影"},{img:"img/img6.png",c_l:400,c_t:160,c_w:300,c_h:300,title:"我和第一千金伊万卡普合张影"}]}}var i=function(){this.startX=this.startY=this.moveX=this.moveY=null,this.previousPinchScale=1,this.longTapTimeout=null};i.prototype._getTime=function(){return(new Date).getTime()},i.prototype._getDistance=function(t,i){return Math.sqrt(t*t+i*i)},i.prototype._getRotateDirection=function(t,i){return t.x*i.y-i.x*t.y},i.prototype._getRotateAngle=function(t,i){var e=this._getRotateDirection(t,i);e=e>0?-1:1;var o=this._getDistance(t.x,t.y),n=this._getDistance(i.x,i.y),s=o*n;if(0===s)return 0;var a=t.x*i.x+t.y*i.y,h=a/s;return h>1&&(h=1),-1>h&&(h=-1),Math.acos(h)*e*180/Math.PI},i.prototype._onTouchStart=function(t){if(window.stage){var i=t.touches?t.touches[0]:t;this.startX=i.pageX,this.startY=i.pageY,window.clearTimeout(this.longTapTimeout);if(t.touches.length>1){var e=t.touches[1],o=Math.abs(e.pageX-this.startX),n=Math.abs(e.pageY-this.startY);this.touchDistance=this._getDistance(o,n),this.touchVector={x:e.pageX-this.startX,y:e.pageY-this.startY}}else this.startTime=this._getTime(),this.longTapTimeout=setTimeout(function(){},800),this.previousTouchPoint&&Math.abs(this.startX-this.previousTouchPoint.startX)<10&&Math.abs(this.startY-this.previousTouchPoint.startY)<10&&Math.abs(this.startTime-this.previousTouchTime)<300,this.previousTouchTime=this.startTime,this.previousTouchPoint={startX:this.startX,startY:this.startY}}},i.prototype._onTouchMove=function(t){if(window.stage){{this._getTime()}if(t.touches.length>1){var i=Math.abs(t.touches[0].pageX-t.touches[1].pageX),e=Math.abs(t.touches[0].pageY-t.touches[1].pageY),o=this._getDistance(i,e);if(this.touchDistance){var n=o/this.touchDistance;n=Math.sqrt(n),this.onPinch({pinch:n-this.previousPinchScale}),this.previousPinchScale=n}if(this.touchVector){var s={x:t.touches[1].pageX-t.touches[0].pageX,y:t.touches[1].pageY-t.touches[0].pageY},a=this._getRotateAngle(s,this.touchVector);this.onRotate({angle:a}),this.touchVector.x=s.x,this.touchVector.y=s.y}}else{window.clearTimeout(this.longTapTimeout);var h=t.touches?t.touches[0]:t,c=null===this.moveX?0:h.pageX-this.moveX,r=null===this.moveY?0:h.pageY-this.moveY;this.onMove({deltaX:c,deltaY:r}),this.moveX=h.pageX,this.moveY=h.pageY}t.preventDefault()}},i.prototype._onTouchCancel=function(t){window.stage&&this._onTouchEnd(t)},i.prototype._onTouchEnd=function(){if(window.stage){window.clearTimeout(this.longTapTimeout);var t=this._getTime();null!==this.moveX&&Math.abs(this.moveX-this.startX)>10||null!==this.moveY&&Math.abs(this.moveY-this.startY)>10?t-this.startTime<500&&this.onSwipe():t-this.startTime<2e3&&(t-this.startTime<500&&this.onTap(),t-this.startTime>500),this.startX=this.startY=this.moveX=this.moveY=null,this.previousPinchScale=1,this.w=this.oImg.width(),this.h=this.oImg.height()}},i.prototype.init=function(){$("#filter").on("touchstart",this._onTouchStart.bind(this)),$("#filter").on("touchmove",this._onTouchMove.bind(this)),$("#filter").on("touchcancel",this._onTouchCancel.bind(this)),$("#filter").on("touchend",this._onTouchEnd.bind(this)),this.oImg=$("#edit_wrap img"),this.x=0,this.y=0,this.pinch=1,this.angle=0,this.w=200,this.h=300},i.prototype.onPinch=function(t){var i=this.pinch+t.pinch,e=window.stage.getChildById("redsun");e.scaleX=i,e.scaleY=i,this.pinch=i},i.prototype.onRotate=function(t){var i=this.angle+t.angle,e=window.stage.getChildById("redsun");e.rotation=i,this.angle=i},i.prototype.onSwipe=function(){},i.prototype.onTap=function(){},i.prototype.onMove=function(t){var i=this.x+t.deltaX,e=this.y+t.deltaY,o=window.stage.getChildById("redsun");o.x=i,o.y=e,this.x=i,this.y=e},i.prototype.toImg=function(){var t=document.createElement("canvas");t.width=710,t.height=819;var i=new Image;i.src=window.stage.canvas.toDataURL();var o=t.getContext("2d");console.log(i.onload);var n=e.type,s=e.config.types[n];$(".result h3").text(s.title),i.onload=function(){o.drawImage(i,s.c_l,s.c_t,s.c_w,s.c_h),console.log(n,s);var e=new Image;e.src=s.img,e.onload=function(){o.drawImage(e,0,0,710,819);var i=new Image;i.src="img/qrcode.png",i.onload=function(){o.drawImage(i,0,0,128,162,570,630,128,162),$("#result").attr("src",t.toDataURL())}}}},t.prototype.load=function(){function t(){o++;var t=parseInt(o/13*100,10);console.log(t),t=t>=100?100:t,$(".loading .process_number").text(t+"%"),$(".loading .process i").css({width:384*t/100+"px"}),100==t&&a&&(s(),a=!1)}for(var i=["img/edit_footer.png","img/edit_header.png","img/img1.png","img/img2.png","img/img3.png","img/img4.png","img/img5.png","img/img6.png","img/loading_bg.jpg","img/map_bg.jpg","img/qrcode.png","img/result_header.png","img/sprite.png"],e=[],o=0,n=i,s=function(){},a=!0,h=n.length-1;h>=0;h--)e[h]=new Image,e[h].src=n[h],e[h].onload=function(){t()},e[h].onerror=function(){t()};return{done:function(t){s=t||s}}},t.prototype.toEdit=function(){var t=this.type,i=this.config.types[t];$(".map").hide().removeClass("active"),$(".edit #edit_wrap")[0].className="type"+(t+1),$("#canvas")[0].width=i.c_w,$("#canvas")[0].height=i.c_h,$(".edit").show()},t.prototype.init=function(){var t=this;this.load().done(function(){$(".loading").fadeOut(),$(".map").fadeIn(),setTimeout(function(){$(".map").addClass("active")},100)}),this.keys.on("touchend",function(){t.type=this.getAttribute("name")-1,setTimeout(function(){t.toEdit()},100)}),$("#inputfile").on("touchend",function(){this.click()}),$("#inputfile").change(function(i){t.reader.readAsDataURL(i.target.files[0])}),$(".btn_save").on("touchend",function(){alert("长按图片，保存到相册")}),$(".result .return").on("touchend",function(){$(".edit").show(),$(".result").hide()}),$(".edit .return").on("touchend",function(){$(".edit").hide(),$(".map").show(),setTimeout(function(){$(".map").addClass("active")},100),window.stage&&window.stage.removeAllChildren()}),this.reader=new FileReader,this.reader.onload=function(t){var i=new Image;i.src=t.target.result,i.onload=function(){window.stage=window.stage?window.stage:new Hilo.Stage({canvas:$("#canvas")[0]}),stage.removeAllChildren();var t=new Hilo.Ticker(120);t.addTick(Hilo.Tween),t.addTick(stage),t.start();new Hilo.Bitmap({id:"redsun",image:i,rect:[0,0,i.width,i.height],y:0,x:0,pivotX:i.width/2,pivotY:i.height/2}).addTo(stage)}}};var e=new t;e.init();var o=new i;o.init(),$("#toImg").on("touchend",function(){o.toImg(),$(".edit").hide(),$(".result").show()})}document.addEventListener("touchmove",t,!1),document.addEventListener("touchstart",t,!1),$(i)}();